<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–ü–æ–±–µ–≥ ‚Äî –≤—ã–±–æ—Ä —É—Ä–æ–≤–Ω–µ–π</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#eff1f3;font-family:system-ui,Segoe UI,Roboto,Manrope,sans-serif}
  #wrap{display:flex;align-items:center;justify-content:center;height:100%}
  canvas{background:#dfe6ea;box-shadow:0 8px 30px rgba(0,0,0,.15);border-radius:14px;max-width:100%;height:auto;touch-action:none}
  .hud{position:fixed;left:10px;top:10px;background:rgba(255,255,255,.92);padding:6px 10px;border-radius:10px;font-weight:800;z-index:2}
  .timer{position:fixed;right:10px;top:10px;background:rgba(255,255,255,.92);padding:6px 10px;border-radius:10px;font-weight:800;z-index:2}
  .summary{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:3}
  .summary .card{background:#fff;border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.25);max-width:560px;width:100%;padding:22px}
  .summary h2{margin:0 0 8px 0}
  .btn{padding:10px 18px;font-size:16px;font-weight:700;border:none;border-radius:10px;cursor:pointer;background:#ff6b35;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.2)}
  .btn.secondary{background:#2f80ed}
  .btn.ghost{background:#fff;color:#333;border:2px solid #d0d7de;box-shadow:none}
  .hidden{display:none}
  /* –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω–µ–π */
  .menu{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:4}
  .menu .card{background:#fff;border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.25);max-width:640px;width:100%;padding:22px}
  .menu h1{margin:0 0 10px 0}
  .menu .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  /* –º–∏–Ω–∏-–∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
  .mini{
    position:fixed;left:10px;top:10px;z-index:5;
    background:#fff;border:2px solid #d0d7de;border-radius:12px;
    padding:6px 10px;font-weight:700;box-shadow:0 3px 12px rgba(0,0,0,.12);
    cursor:pointer
  }
  .help{position:fixed;left:10px;bottom:10px;background:rgba(255,255,255,.92);padding:6px 10px;border-radius:10px;font-weight:600;z-index:2}
</style>
</head>
<body>
<div class="hud" id="hud">ü™ô <span id="score">0</span> ¬∑ ‚ù§Ô∏è <span id="lives">3</span> ¬∑ üîß <span id="weapon">–Ω–µ—Ç</span></div>
<div class="timer" id="timer">‚è±Ô∏è <span id="time">30</span> c</div>
<div id="wrap"><canvas id="game" width="1024" height="576"></canvas></div>

<!-- –º–∏–Ω–∏-–∫–Ω–æ–ø–∫–∞ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –º–µ–Ω—é -->
<button id="menuMini" class="mini hidden" title="–û—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è">üìÇ –£—Ä–æ–≤–Ω–∏</button>

<!-- –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è -->
<div id="menu" class="menu">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h1 style="margin:0">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</h1>
      <button id="minBtn" class="btn ghost" title="–°–≤–µ—Ä–Ω—É—Ç—å –≤ –ª–µ–≤—ã–π –≤–µ—Ä—Ö">‚Üñ –°–≤–µ—Ä–Ω—É—Ç—å</button>
    </div>
    <p>–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º. Esc ‚Äî –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º—ã—à—å.</p>
    <div class="grid">
      <button id="btnL1" class="btn">–£—Ä–æ–≤–µ–Ω—å 1 ‚Äî –ü–∞—Ä–∫—É—Ä –ø–æ–±–µ–≥</button>
      <button id="btnL2" class="btn secondary">–£—Ä–æ–≤–µ–Ω—å 2 ‚Äî 1-–ª–∏—Ü–æ (–º–∞–π–Ω–∫—Ä–∞—Ñ—Ç)</button>
    </div>
  </div>
</div>

<div id="summary" class="summary hidden" role="dialog" aria-modal="true">
  <div class="card">
    <h2 id="sumTitle">–ú–∏—Å—Å–∏—è!</h2>
    <p id="sumText"></p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button id="restart" class="btn">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      <button id="toMenu" class="btn secondary">üè† –í –º–µ–Ω—é —É—Ä–æ–≤–Ω–µ–π</button>
    </div>
  </div>
</div>

<div id="help" class="help hidden"></div>

<script>
(() => {
  // ===== DOM
  const c = document.getElementById('game');
  const ctx = c.getContext('2d');
  const hud = document.getElementById('hud');
  const timerBox = document.getElementById('timer');
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const weaponEl= document.getElementById('weapon');
  const timeEl  = document.getElementById('time');
  const menuEl  = document.getElementById('menu');
  const btnL1   = document.getElementById('btnL1');
  const btnL2   = document.getElementById('btnL2');
  const minBtn  = document.getElementById('minBtn');
  const menuMini= document.getElementById('menuMini');
  const sumEl   = document.getElementById('summary');
  const sumTitle= document.getElementById('sumTitle');
  const sumText = document.getElementById('sumText');
  const restartBtn = document.getElementById('restart');
  const toMenuBtn  = document.getElementById('toMenu');
  const helpEl = document.getElementById('help');

  let MODE = 'menu'; // menu | level1 | level2 | ended
  let RAF = 0;

  // ======= LEVEL 1 (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—Ç–∞—Ä—Ç, —Ä–µ—Å–ø–∞–≤–Ω, —Ñ–∏–Ω–∏—à-–æ–∫–Ω–æ, —á–µ—Ä–≤—å)
  const L1 = (() => {
    const W = 2400, H = c.height;
    const GRAV=0.9, JUMP=-16, Fg=0.86, Fa=0.985, MAX_VX=7, MAX_VY=24, EPS=0.0001;

    const platforms = [
      {x:0,y:520,w:2400,h:200,color:'#c7baa1'},
      {x:80,y:440,w:220,h:18,color:'#b9ad90'},
      {x:330,y:380,w:120,h:18,color:'#b9ad90'},
      {x:520,y:330,w:160,h:18,color:'#b9ad90'},
      {x:740,y:280,w:140,h:18,color:'#b9ad90'},
      {x:1000,y:420,w:250,h:18,color:'#b9ad90'},
      {x:1280,y:360,w:110,h:18,color:'#b9ad90'},
      {x:1460,y:300,w:170,h:18,color:'#b9ad90'},
      {x:1680,y:260,w:140,h:18,color:'#b9ad90'},
      {x:300,y:470,w:90,h:14,color:'#bcae93'},
      {x:390,y:455,w:90,h:14,color:'#bcae93'},
      {x:480,y:440,w:90,h:14,color:'#bcae93'},
      {x:570,y:425,w:90,h:14,color:'#bcae93'},
      {x:1950,y:520,w:450,h:200,color:'#c7baa1'},
      {x:1980,y:460,w:140,h:18,color:'#b9ad90'},
      {x:2140,y:420,w:120,h:18,color:'#b9ad90'},
      {x:2280,y:470,w:90,h:18,color:'#b9ad90'},
    ];
    const ladders = [
      {x:155, y:320, h:120, w:22, type:'ladder'},
      {x:560, y:180, h:150, w:22, type:'ladder'},
      {x:1010,y:280, h:140, w:18, type:'rope'},
      {x:2145,y:260, h:160, w:18, type:'ladder'},
    ];
    const buildings = [{x:0,w:220},{x:260,w:220},{x:520,w:220},{x:820,w:260},{x:1120,w:300},{x:1490,w:260},{x:1800,w:300}];

    const player = {x:0,y:420,w:28,h:42,vx:0,vy:0,dir:1,onGround:false,climb:false,hasWeapon:false,inv:0,lives:3};
    const cops=[], coins=[]; let particles=[];
    let goal={x:2100,y:400,w:56,h:120};
    let worm={x:2050,y:520,w:120,h:50,vx:2.2,left:1900,right:2350};

    let score=0, timeLeft=30000, camX=0;
    let START_X=100; const SAFE_R=280;

    const keys={left:false,right:false,up:false,down:false};
    function keyOn(){
      const down=e=>{
        if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=true;
        if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=true;
        if(e.code==='ArrowUp'||e.code==='KeyW'||e.code==='Space') keys.up=true;
        if(e.code==='ArrowDown'||e.code==='KeyS') keys.down=true;
      };
      const up=e=>{
        if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=false;
        if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=false;
        if(e.code==='ArrowUp'||e.code==='KeyW'||e.code==='Space') keys.up=false;
        if(e.code==='ArrowDown'||e.code==='KeyS') keys.down=false;
      };
      const click=()=>{/* –∞—Ç–∞–∫–∏ –Ω–µ—Ç */};
      window.addEventListener('keydown',down);
      window.addEventListener('keyup',up);
      c.addEventListener('pointerdown',click);
      return {down,up,click};
    }
    let handlers=null;

    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const aabb=(a,b)=>!(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);
    function integrateY(e, dt, ignore=false){
      const prevTop=e.y, prevBottom=e.y+e.h;
      if(!ignore && e.vy>0){
        const nextBottom=e.y+e.vy+e.h;
        for(const p of platforms){
          if(!(e.x< p.x+p.w && e.x+e.w>p.x)) continue;
          const floor=p.y;
          if(prevBottom<=floor+EPS && nextBottom>=floor-EPS){ e.y=floor-e.h; e.vy=0; e.onGround=true; return; }
        }
      }
      if(!ignore && e.vy<0){
        const nextTop=e.y+e.vy;
        for(const p of platforms){
          if(!(e.x< p.x+p.w && e.x+e.w>p.x)) continue;
          const ceil=p.y+p.h;
          if(prevTop>=ceil-EPS && nextTop<=ceil+EPS){ e.y=ceil; e.vy=0; break; }
        }
      }
      e.y+=e.vy;
    }

    function ladderUnder(e){
      for(const L of ladders){ const r={x:L.x-10,y:L.y,w:L.w+20,h:L.h}; if(aabb(e,r)) return L; }
      return null;
    }

    function updatePlayer(dt){
      player.inv=Math.max(0,player.inv-dt);
      const accel=player.onGround?1:0.55;
      if(keys.left){player.vx-=accel; player.dir=-1;}
      if(keys.right){player.vx+=accel; player.dir=1;}
      player.vx*=(player.onGround?Fg:Fa); player.vx=clamp(player.vx,-MAX_VX,MAX_VX); player.x+=player.vx;

      const L = ladderUnder(player);
      player.climb= !!L && (keys.up||keys.down);
      if(player.climb){
        player.vy=0; if(keys.up)player.y-=3; if(keys.down)player.y+=3.2;
        player.x = L.x + L.w/2 - player.w/2; integrateY(player,dt,true); player.onGround=false;
      } else {
        if(keys.up && player.onGround){ player.vy=JUMP; player.onGround=false; }
        player.vy+=GRAV; player.vy=clamp(player.vy,-MAX_VY,MAX_VY); player.onGround=false; integrateY(player,dt,false);
      }

      player.x=clamp(player.x,0,W-player.w);
      if(player.y>H-1){ player.y=H-1; player.vy=0; player.onGround=true; }
      camX = clamp(player.x + player.w/2 - c.width/2, 0, W - c.width);

      // –º–æ–Ω–µ—Ç—ã (–ø—Ä–æ—Å—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç –∏ —Å—á—ë—Ç)
      for(const m of coins){
        if(!m.taken && Math.hypot(player.x+player.w/2-m.x, player.y+player.h/2-m.y) < m.r+16){
          m.taken=true; score++; scoreEl.textContent=score;
          particles.push({x:m.x,y:m.y,vx:0,vy:-2,g:0.05,life:600,txt:'ü™ô'});
        }
      }

      // —Ñ–∏–Ω–∏—à
      if(aabb(player, goal)) finish();
    }

    function respawnToStart(){
      Object.assign(player,{x:START_X,y:420,vx:0,vy:0,onGround:false,climb:false});
      player.inv=1000; camX=0;
    }

    function updateCops(dt){
      for(const cop of cops){
        const speed=1.6;
        if(Math.abs((cop.x+cop.w/2)-(player.x+player.w/2))>4) cop.vx += (player.x>cop.x? speed:-speed)*0.08;
        cop.vx=clamp(cop.vx,-2.2,2.2); cop.x+=cop.vx;
        cop.vy+=GRAV; cop.vy=clamp(cop.vy,-24,24); integrateY(cop,dt,false);

        if(player.inv<=0 && aabb(cop,player)){
          player.lives--; livesEl.textContent=player.lives;
          respawnToStart();
          if(player.lives<=0){ fail(); return; }
        }
      }
    }

    // –ß–µ—Ä–≤—å –ø–æ–ª–∑–∞–µ—Ç —Ç—É–¥–∞-—Å—é–¥–∞
    function updateWorm(dt){
      worm.x += worm.vx * (dt/16.67);
      if(worm.x < worm.left || worm.x > worm.right) worm.vx *= -1;
      const hitBox = {x:worm.x-60, y:worm.y- worm.h, w:120, h:worm.h};
      if(player.inv<=0 && aabb(hitBox, player)){
        player.lives--; livesEl.textContent=player.lives;
        respawnToStart();
        if(player.lives<=0){ fail(); }
      }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Å—Å–∏–∏
    function spawnCoins(n=24){
      coins.length=0;
      for(let i=0;i<n;i++){
        const p = platforms[1 + Math.floor(Math.random()*(platforms.length-1))];
        const x = p.x + 10 + Math.random()*(p.w-20);
        const y = p.y - 16;
        coins.push({x,y,r:8,taken:false});
      }
    }
    function spawnCopsRandom(n=10){
      cops.length=0; let tries=0;
      while(cops.length<n && tries<200){
        const x = 160 + Math.random()*(W-320);
        if(Math.abs(x-START_X)>SAFE_R) cops.push({x,y:420,w:30,h:40,vx:0,vy:0});
        tries++;
      }
    }
    function spawnGoal(){ const x = 1200 + Math.random()*(W-1300); goal={x:Math.floor(x), y:400, w:56, h:120}; }
    function spawnWorm(){ worm={x:2050, y:520, w:120, h:50, vx:2.2, left:1900, right:2350}; }

    function drawGoal(){
      ctx.fillStyle='#2f80ed'; ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
      ctx.fillStyle='#9bc3ff'; ctx.fillRect(goal.x+6, goal.y+8, goal.w-12, goal.h-16);
      ctx.fillStyle='#2f80ed'; ctx.fillRect(goal.x+6, goal.y+goal.h/2-2, goal.w-12, 4);
      ctx.fillRect(goal.x+goal.w/2-2, goal.y+8, 4, goal.h-16);
    }
    function drawWorm(){
      ctx.fillStyle='#7a4c2a'; ctx.beginPath();
      ctx.ellipse(worm.x, worm.y - worm.h/2, worm.w/2, worm.h/2, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='#5b371c'; ctx.beginPath(); ctx.arc(worm.x+(worm.vx>0?14:-14), worm.y - worm.h + 20, 6, 0, Math.PI*2); ctx.fill();
    }

    function render(){
      ctx.clearRect(0,0,c.width,c.height);
      ctx.fillStyle='#eef3f6'; ctx.fillRect(0,0,c.width,c.height);
      ctx.save(); ctx.translate(-camX,0);

      // —Ñ–æ–Ω-–≥–æ—Ä–æ–¥
      ctx.fillStyle='#cfd7dd';
      for(const b of buildings){
        ctx.fillRect(b.x,150,b.w,370);
        ctx.fillStyle='#e8eff4';
        for(let y=170;y<500;y+=48) for(let x=b.x+12;x<b.x+b.w-12;x+=40) ctx.fillRect(x,y,24,16);
        ctx.fillStyle='#cfd7dd';
      }

      // –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
      for(const p of platforms){ ctx.fillStyle=p.color||'#b9ad90'; ctx.fillRect(p.x,p.y,p.w,p.h||18); }

      // –ª–µ—Å—Ç–Ω–∏—Ü—ã/–∫–∞–Ω–∞—Ç—ã
      for(const L of ladders){
        if(L.type==='ladder'){
          ctx.fillStyle='#9b7a55'; ctx.fillRect(L.x,L.y,L.w,L.h);
          ctx.strokeStyle='#734f2e'; ctx.lineWidth=2;
          for(let y=L.y;y<L.y+L.h;y+=16){ ctx.beginPath(); ctx.moveTo(L.x-6,y); ctx.lineTo(L.x+L.w+6,y); ctx.stroke(); }
        } else {
          ctx.strokeStyle='#7a5f44'; ctx.lineWidth=6;
          ctx.beginPath(); ctx.moveTo(L.x+L.w/2,L.y); ctx.lineTo(L.x+L.w/2,L.y+L.h); ctx.stroke();
        }
      }

      // –º–æ–Ω–µ—Ç—ã
      ctx.font='20px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji'; ctx.textAlign='center'; ctx.textBaseline='middle';
      for(const m of coins) if(!m.taken) ctx.fillText('ü™ô', m.x, m.y);

      // –∫–æ–ø—ã
      for(const cop of cops){
        ctx.fillStyle='#2a61ff'; ctx.fillRect(cop.x,cop.y,cop.w,cop.h);
        ctx.fillStyle='#3c72ff'; ctx.fillRect(cop.x-6,cop.y+10,cop.w+12,24);
        ctx.fillStyle='#1d3e9a'; ctx.fillRect(cop.x,cop.y-8,cop.w,10);
      }

      drawWorm();
      drawGoal();

      // –∏–≥—Ä–æ–∫
      const blink = player.inv>0 && Math.floor(performance.now()/120)%2===0;
      if(!blink){ ctx.fillStyle='#222'; ctx.fillRect(player.x, player.y, player.w, player.h); ctx.fillStyle='#ff6b35'; ctx.fillRect(player.x, player.y+10, player.w, 6); }

      // —á–∞—Å—Ç–∏—Ü—ã
      for(let i=particles.length-1;i>=0;i--){
        const p=particles[i]; p.life-=16; p.x+=p.vx; p.y+=p.vy; p.vy+=p.g;
        if(p.life<=0) particles.splice(i,1);
        else { ctx.globalAlpha=Math.max(0,Math.min(1,p.life/600)); ctx.fillText(p.txt, p.x, p.y); ctx.globalAlpha=1; }
      }

      ctx.restore();
    }

    let last=0;
    function loop(t){
      if(MODE!=='level1') return;
      const dt = Math.min(33, t-last||16); last=t;
      timeLeft=Math.max(0,timeLeft-dt); timeEl.textContent=Math.ceil(timeLeft/1000);
      if(timeLeft<=0){ fail(); return; }
      updatePlayer(dt); updateCops(dt); updateWorm(dt); render();
      RAF=requestAnimationFrame(loop);
    }

    function finish(){ MODE='ended'; sumTitle.textContent='–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!'; sumText.innerHTML=`–°–æ–±—Ä–∞–Ω–æ –º–æ–Ω–µ—Ç: <b>${score}</b>`; sumEl.classList.remove('hidden'); }
    function fail(){ MODE='ended'; sumTitle.textContent='–ü–æ—Ä–∞–∂–µ–Ω–∏–µ'; sumText.innerHTML=`–ú–æ–Ω–µ—Ç —Å–æ–±—Ä–∞–Ω–æ: <b>${score}</b>`; sumEl.classList.remove('hidden'); }

    function restart(){
      START_X = 60 + (Math.random()*180|0);            // —Å–ª—É—á–∞–π–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ —Å—Ç–∞—Ä—Ç–∞
      Object.assign(player,{x:START_X,y:420,w:28,h:42,vx:0,vy:0,dir:1,onGround:false,climb:false,hasWeapon:false,inv:0,lives:3});
      score=0; scoreEl.textContent=0; timeLeft=30000; timeEl.textContent=30;
      livesEl.textContent=3; weaponEl.textContent='–Ω–µ—Ç'; camX=0; particles.length=0;
      spawnCoins(); spawnCopsRandom(10); spawnGoal(); spawnWorm();
      last=performance.now(); RAF=requestAnimationFrame(loop);
    }
    function start(){ hud.classList.remove('hidden'); timerBox.classList.remove('hidden'); sumEl.classList.add('hidden'); helpEl.classList.add('hidden'); handlers=keyOn(); restart(); }
    function stop(){
      if(handlers){
        window.removeEventListener('keydown',handlers.down);
        window.removeEventListener('keyup',handlers.up);
        c.removeEventListener('pointerdown',handlers.click);
        handlers=null;
      }
      cancelAnimationFrame(RAF);
    }

    return {start,stop,restart};
  })();

  // ======= LEVEL 2 ‚Äî 1-–ª–∏—Ü–æ —Å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—ë–º (7 –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
  const L2 = (() => {
    const WMAP=24, HMAP=24;
    let map=[], px=4,py=12,ang=0,vx=0,vy=0;
    const FOV=Math.PI*70/180, MOVE=0.06, FRI=0.82;
    const colors = {0:'#0000',1:'#8b5a2b',2:'#6d6d6d',3:'#c86dbd',4:'#f4d35e',5:'#8c7a62',6:'#7ad0ff'};
    const names  = {1:'–∑–µ–º–ª—è',2:'–∫–∞–º–µ–Ω—å',3:'–∫—Ä–æ–≤–∞—Ç—å',4:'—Ñ–∞–∫–µ–ª',5:'–∫—Ä–µ—Å—Ç',6:'–æ–∫–Ω–æ'};
    const items = [
      {id:'dirt',icon:'üü´',place:1,tip:'–ü–æ—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫'},
      {id:'pick',icon:'‚õèÔ∏è',mine:true,tip:'–°–ª–æ–º–∞—Ç—å –±–ª–æ–∫'},
      {id:'bed',icon:'üõèÔ∏è',place:3,tip:'–ü–æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–æ–≤–∞—Ç—å'},
      {id:'sword',icon:'üó°Ô∏è',swing:true,tip:'–í–∑–º–∞—Ö –º–µ—á–æ–º'},
      {id:'torch',icon:'üïØÔ∏è',place:4,tip:'–ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ–∞–∫–µ–ª'},
      {id:'cross',icon:'‚úùÔ∏è',place:5,tip:'–ü–æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–µ—Å—Ç'},
      {id:'window',icon:'ü™ü',place:6,tip:'–ü–æ—Å—Ç–∞–≤–∏—Ç—å –æ–∫–Ω–æ'}
    ]; let selected=0, handT=0, info='';
    const keys={w:false,s:false,a:false,d:false,q:false,e:false};
    let removeHandlers= null;

    function genMap(){
      map = Array.from({length:HMAP},(_,y)=>Array.from({length:WMAP},(_,x)=> (x===0||y===0||x===WMAP-1||y===HMAP-1)?2:0 ));
      for(let i=0;i<28;i++){
        const x=2+Math.floor(Math.random()*(WMAP-4));
        const y=2+Math.floor(Math.random()*(HMAP-4));
        map[y][x] = (Math.random()<0.6?1:2);
      }
      for(let x=2;x<WMAP-2;x++) map[12][x]=0; // –∫–æ—Ä–∏–¥–æ—Ä
      px=4; py=12; ang=0; vx=vy=0;
    }
    const cell=(x,y)=> (map[y]?.[x]??2);
    const canMove=(nx,ny)=> cell(Math.floor(nx),Math.floor(ny))===0;

    function start(){
      helpEl.classList.remove('hidden');
      helpEl.textContent='WASD ‚Äî —Ö–æ–¥—å–±–∞, Q/E –∏–ª–∏ ‚Üê/‚Üí ‚Äî –ø–æ–≤–æ—Ä–æ—Ç, –∫–æ–ª–µ—Å–æ/1‚Äì7 ‚Äî –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –õ–ö–ú ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ.';
      hud.classList.add('hidden'); timerBox.classList.add('hidden'); sumEl.classList.add('hidden');
      genMap(); selected=0; info='';
      removeHandlers = addHandlers(); MODE='level2'; RAF=requestAnimationFrame(loop);
    }
    function stop(){ if(removeHandlers) removeHandlers(); removeHandlers=null; cancelAnimationFrame(RAF); document.exitPointerLock?.(); }
    function restart(){ start(); }

    function addHandlers(){
      const down=e=>{
        if(e.code==='KeyW'||e.code==='ArrowUp') keys.w=true;
        if(e.code==='KeyS'||e.code==='ArrowDown') keys.s=true;
        if(e.code==='KeyA') keys.a=true; if(e.code==='KeyD') keys.d=true;
        if(e.code==='KeyQ'||e.code==='ArrowLeft') keys.q=true; if(e.code==='KeyE'||e.code==='ArrowRight') keys.e=true;
        if(e.code>='Digit1'&&e.code<='Digit7') selected=+e.code.slice(5)-1;
        if(e.code==='Escape') document.exitPointerLock?.();
      };
      const up=e=>{
        if(e.code==='KeyW'||e.code==='ArrowUp') keys.w=false;
        if(e.code==='KeyS'||e.code==='ArrowDown') keys.s=false;
        if(e.code==='KeyA') keys.a=false; if(e.code==='KeyD') keys.d=false;
        if(e.code==='KeyQ'||e.code==='ArrowLeft') keys.q=false; if(e.code==='KeyE'||e.code==='ArrowRight') keys.e=false;
      };
      const wheel=e=>{ e.preventDefault(); selected=(selected+(e.deltaY>0?1:-1)+items.length)%items.length; };
      const click=()=>{ c.requestPointerLock?.(); };
      const mdown=()=>{ act(); };
      const onMouseMove = e=>{ if(document.pointerLockElement===c) ang += e.movementX*0.0025; };
      window.addEventListener('keydown',down); window.addEventListener('keyup',up);
      window.addEventListener('wheel',wheel,{passive:false});
      window.addEventListener('mousemove', onMouseMove);
      c.addEventListener('click',click); c.addEventListener('mousedown', mdown);
      return ()=>{ window.removeEventListener('keydown',down); window.removeEventListener('keyup',up);
        window.removeEventListener('wheel',wheel); window.removeEventListener('mousemove', onMouseMove);
        c.removeEventListener('click',click); c.removeEventListener('mousedown', mdown); };
    }

    function act(){
      const it=items[selected]; handT=1;
      if(it.mine){
        for(let t=0.1;t<3;t+=0.1){
          const cx=Math.floor(px+Math.cos(ang)*t), cy=Math.floor(py+Math.sin(ang)*t);
          if(cell(cx,cy)!==0){ info='–°–ª–æ–º–∞–ª–∏ '+(names[cell(cx,cy)]||'–±–ª–æ–∫'); map[cy][cx]=0; return; }
        }
        info='–ù–µ—á–µ–≥–æ –ª–æ–º–∞—Ç—å'; return;
      }
      if(it.swing){ /* –∞–Ω–∏–º–∞—Ü–∏—è –≤–∑–º–∞—Ö–∞ */ return; }
      if(it.place){
        for(let t=0;t<3;t+=0.1){
          const cx=Math.floor(px+Math.cos(ang)*t), cy=Math.floor(py+Math.sin(ang)*t);
          if(cell(cx,cy)===0){ map[cy][cx]=it.place; info='–ü–æ—Å—Ç–∞–≤–∏–ª–∏ '+(names[it.place]||'–±–ª–æ–∫'); return; }
        }
        info='–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –Ω–µ—Ç –º–µ—Å—Ç–∞';
      }
    }

    function update(){
      if(keys.q) ang-=0.05; if(keys.e) ang+=0.05;
      const dx=Math.cos(ang), dy=Math.sin(ang), sx=-Math.sin(ang), sy=Math.cos(ang);
      if(keys.w){ vx+=dx*MOVE; vy+=dy*MOVE; }
      if(keys.s){ vx-=dx*MOVE; vy-=dy*MOVE; }
      if(keys.a){ vx+=sx*MOVE; vy+=sy*MOVE; }
      if(keys.d){ vx-=sx*MOVE; vy-=sy*MOVE; }
      vx*=FRI; vy*=FRI;
      const nx=px+vx, ny=py+vy; if(canMove(nx,py)) px=nx; else vx=0; if(canMove(px,ny)) py=ny; else vy=0;
    }

    function render3D(){
      const sky = ctx.createLinearGradient(0,0,0,c.height/2); sky.addColorStop(0,'#bfe1ff'); sky.addColorStop(1,'#e6f2ff');
      ctx.fillStyle=sky; ctx.fillRect(0,0,c.width,c.height/2);
      const ground = ctx.createLinearGradient(0,c.height/2,0,c.height); ground.addColorStop(0,'#cfe7cf'); ground.addColorStop(1,'#b8d7b8');
      ctx.fillStyle=ground; ctx.fillRect(0,c.height/2,c.width,c.height/2);

      const COLS=256, colW=c.width/COLS;
      for(let i=0;i<COLS;i++){
        const camX = 2*i/COLS-1;
        const rayX = Math.cos(ang)+Math.cos(ang+Math.PI/2)*camX*2*Math.tan(FOV/2);
        const rayY = Math.sin(ang)+Math.sin(ang+Math.PI/2)*camX*2*Math.tan(FOV/2);
        let mapX=Math.floor(px), mapY=Math.floor(py);
        const deltaX=Math.abs(1/(rayX||1e-6)), deltaY=Math.abs(1/(rayY||1e-6));
        let stepX,stepY, sideX,sideY;
        if(rayX<0){stepX=-1;sideX=(px-mapX)*deltaX;} else {stepX=1;sideX=(mapX+1-px)*deltaX;}
        if(rayY<0){stepY=-1;sideY=(py-mapY)*deltaY;} else {stepY=1;sideY=(mapY+1-py)*deltaY;}
        let hit=0,side=0,type=0;
        while(!hit && mapX>=0&&mapY>=0&&mapX<WMAP&&mapY<HMAP){
          if(sideX<sideY){ sideX+=deltaX; mapX+=stepX; side=0; } else { sideY+=deltaY; mapY+=stepY; side=1; }
          type = map[mapY][mapX]; if(type>0) hit=1;
        }
        const dist = (side===0? sideX-deltaX : sideY-deltaY);
        const h = Math.max(1, Math.floor(c.height/(dist||1e-6))); const y0=(c.height-h)>>1;
        ctx.fillStyle=colors[type]||'#777'; ctx.globalAlpha= side?0.85:1; ctx.fillRect(i*colW,y0,colW+1,h); ctx.globalAlpha=1;
      }

      // —Ä—É–∫–∞ –∏ —Ö–æ—Ç–±–∞—Ä
      const sway=Math.sin(performance.now()/250)*4; if(handT>0) handT=Math.max(0,handT-0.08);
      const hit=Math.sin((1-handT)*Math.PI)*20; const bx=c.width-160+sway+hit, by=c.height-120+Math.abs(sway)*0.8;
      ctx.fillStyle='#e5c09c'; ctx.fillRect(bx,by,80,90); ctx.fillStyle='#d6a77f'; ctx.fillRect(bx+10,by+10,60,70);
      ctx.font='28px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(items[selected].icon,bx+24,by+16);

      const w=54,gap=8,total=items.length*w+(items.length-1)*gap, ox=(c.width-total)/2, oy=c.height-66;
      for(let i=0;i<items.length;i++){
        ctx.fillStyle=i===selected?'rgba(47,128,237,.9)':'rgba(255,255,255,.9)';
        ctx.fillRect(ox+i*(w+gap),oy,w,50); ctx.strokeStyle=i===selected?'#1f6bd9':'#999'; ctx.lineWidth=2; ctx.strokeRect(ox+i*(w+gap),oy,w,50);
        ctx.font='24px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#111';
        ctx.fillText(items[i].icon, ox+i*(w+gap)+w/2, oy+25);
        ctx.font='10px system-ui'; ctx.fillStyle='#333'; ctx.fillText(String(i+1), ox+i*(w+gap)+w-8, oy+10);
      }
      if(info){ ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(c.width/2-160,12,320,28); ctx.fillStyle='#fff'; ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.fillText(info, c.width/2, 30); }
    }
    function loop(){ if(MODE!=='level2') return; update(); render3D(); RAF=requestAnimationFrame(loop); }

    return {start,stop,restart};
  })();

  // ===== —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–Ω—é –∏ —Ä–æ—É—Ç–µ—Ä
  function showMenu(){ // —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å
    sumEl.classList.add('hidden');
    menuMini.classList.add('hidden');
    menuEl.classList.remove('hidden');
    document.exitPointerLock?.();
  }
  function minimizeMenu(){ // —Å–≤–µ—Ä–Ω—É—Ç—å
    menuEl.classList.add('hidden');
    menuMini.classList.remove('hidden');
  }

  btnL1.onclick = () => {
    menuEl.classList.add('hidden'); menuMini.classList.add('hidden');
    L2.stop(); L1.start(); MODE='level1';
  };
  btnL2.onclick = () => {
    menuEl.classList.add('hidden'); menuMini.classList.add('hidden');
    L1.stop(); L2.start(); MODE='level2';
  };
  minBtn.onclick = minimizeMenu;
  menuMini.onclick = showMenu;

  restartBtn.onclick = () => {
    sumEl.classList.add('hidden');
    if(MODE==='level1'||MODE==='ended'){ L1.restart(); MODE='level1'; } else { L2.restart(); MODE='level2'; }
  };
  toMenuBtn.onclick  = () => {
    sumEl.classList.add('hidden');
    L1.stop(); L2.stop(); helpEl.classList.add('hidden');
    showMenu(); MODE='menu';
  };

  // –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ M ‚Äî —Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é
  window.addEventListener('keydown', (e)=>{
    if(e.code==='KeyM'){
      if(menuEl.classList.contains('hidden')) showMenu(); else minimizeMenu();
    }
  });

  // –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  showMenu();
})();
</script>
</body>
</html>
